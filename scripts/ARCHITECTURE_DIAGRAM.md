# System Architecture Diagram

## Payment Flow Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                        PAYROLL SYSTEM                            │
└─────────────────────────────────────────────────────────────────┘

┌──────────────┐
│  Create      │
│  Pay Run     │
└──────┬───────┘
       │
       ▼
┌──────────────┐
│  DRAFT       │
└──────┬───────┘
       │
       ▼
┌──────────────┐      ┌──────────────────┐
│  APPROVE     │─────▶│  APPROVAL_PENDING │
└──────────────┘      └──────┬─────────────┘
                             │
                             ▼
                    ┌──────────────────┐
                    │ VALIDATE FUNDS   │
                    │ - Sync Balance   │
                    │ - Check KYC      │
                    │ - Lock Funds    │
                    └──────┬───────────┘
                           │
                           ▼
                    ┌──────────────────┐
                    │ FUNDS_VALIDATED  │
                    └──────┬───────────┘
                           │
                           ▼
                    ┌──────────────────┐
                    │ PROCESS PAYMENTS │
                    │ - Fraud Check    │
                    │ - Create Payouts │
                    └──────┬───────────┘
                           │
                           ▼
                    ┌──────────────────┐
                    │ PAYOUT_INITIATED │
                    └──────┬───────────┘
                           │
        ┌──────────────────┼──────────────────┐
        │                  │                   │
        ▼                  ▼                   ▼
┌──────────────┐  ┌──────────────┐  ┌──────────────┐
│  COMPLETED   │  │  PARTIALLY   │  │   FAILED     │
│              │  │  COMPLETED   │  │              │
└──────────────┘  └──────────────┘  └──────────────┘
```

## Component Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                      FRONTEND (React)                        │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ PayRunMgmt   │  │ Transactions │  │ FraudAlerts │      │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘      │
└─────────┼─────────────────┼─────────────────┼─────────────┘
          │                 │                 │
          ▼                 ▼                 ▼
┌─────────────────────────────────────────────────────────────┐
│                    BACKEND API (Flask)                       │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  PayRuns API │  │ Payments API │  │ Fraud API    │      │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘      │
└─────────┼─────────────────┼─────────────────┼─────────────┘
          │                 │                 │
          ▼                 ▼                 ▼
┌─────────────────────────────────────────────────────────────┐
│                      SERVICES LAYER                          │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ Wallet       │  │ Payment      │  │ Fraud        │      │
│  │ Balance      │  │ Service      │  │ Detector     │      │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘      │
│         │                 │                 │                │
│  ┌──────┴───────┐  ┌──────┴───────┐  ┌──────┴───────┐      │
│  │ Reconciliation│  │ Penny-Drop  │  │ Audit Logger │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────┼─────────────────┼─────────────────┼─────────────┘
          │                 │                 │
          ▼                 ▼                 ▼
┌─────────────────────────────────────────────────────────────┐
│                      DATABASE (MySQL)                         │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ PayRun       │  │ PaymentTxn   │  │ FraudAlert   │      │
│  │ Wallet       │  │ BankAccount  │  │              │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
          │
          ▼
┌─────────────────────────────────────────────────────────────┐
│                    EXTERNAL SERVICES                         │
│  ┌──────────────────────────────────────────────────────┐   │
│  │              Razorpay Payouts API                     │   │
│  │  - Create Payouts                                    │   │
│  │  - Check Status                                      │   │
│  │  - Webhook Callbacks                                 │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

## State Machine Diagram

```
                    ┌─────────┐
                    │  DRAFT  │
                    └────┬────┘
                         │ approve
                         ▼
              ┌──────────────────────┐
              │  APPROVAL_PENDING    │
              └────┬─────────────────┘
                   │ validate funds
                   ▼
              ┌──────────────────────┐
              │  FUNDS_VALIDATED      │
              │  [Funds Locked]       │
              └────┬─────────────────┘
                   │ process payments
                   ▼
              ┌──────────────────────┐
              │  PAYOUT_INITIATED    │
              └────┬─────────────────┘
                   │
        ┌──────────┼──────────┐
        │          │          │
        ▼          ▼          ▼
   ┌────────┐ ┌────────┐ ┌────────┐
   │COMPLETE│ │PARTIAL │ │ FAILED │
   └────────┘ └────────┘ └────┬───┘
                              │
                              ▼
                         ┌────────┐
                         │REVERSED│
                         └────────┘
```

## Security Architecture

```
┌─────────────────────────────────────────────────────────┐
│                  SECURITY LAYERS                         │
│                                                           │
│  ┌─────────────────────────────────────────────────┐   │
│  │ 1. Authentication (JWT)                          │   │
│  └─────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────┐   │
│  │ 2. Authorization (Role-Based)                  │   │
│  └─────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────┐   │
│  │ 3. Data Encryption (Fernet)                    │   │
│  └─────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────┐   │
│  │ 4. Data Masking (Logs)                         │   │
│  └─────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────┐   │
│  │ 5. Webhook Signature Verification (HMAC)       │   │
│  └─────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────┐   │
│  │ 6. Fraud Detection (Multi-Rule)                 │   │
│  └─────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────┐   │
│  │ 7. Audit Logging (Immutable)                    │   │
│  └─────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────┐   │
│  │ 8. Idempotency (Duplicate Prevention)          │   │
│  └─────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
```

## Concurrency Control

```
┌─────────────────────────────────────────────────────────┐
│           FUND LOCKING (Row-Level Locking)              │
│                                                           │
│  Payrun 1: SELECT ... FOR UPDATE ──┐                    │
│                                     │                    │
│  Payrun 2: SELECT ... FOR UPDATE ──┼──▶ BLOCKED         │
│                                     │                    │
│  Payrun 1: Lock Funds ─────────────┘                    │
│  Payrun 2: Wait/Retry/Fail                               │
│                                                           │
│  Result: No double-spending                              │
└─────────────────────────────────────────────────────────┘
```

## Reconciliation Flow

```
┌─────────────────────────────────────────────────────────┐
│              RECONCILIATION PROCESS                       │
│                                                           │
│  Cron Job (Every 15-30 min)                              │
│       │                                                   │
│       ▼                                                   │
│  Find Stuck Payments (> 2 hours)                          │
│       │                                                   │
│       ▼                                                   │
│  Query Razorpay API                                       │
│       │                                                   │
│       ▼                                                   │
│  Compare Status                                           │
│       │                                                   │
│       ▼                                                   │
│  Update if Mismatch                                        │
│       │                                                   │
│       ▼                                                   │
│  Update Payrun Status                                     │
└─────────────────────────────────────────────────────────┘
```

